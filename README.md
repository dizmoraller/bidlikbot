## Быдлик бот

Телеграм‑бот, который реагирует на ключевые фразы, проводит “развлечения” вроде “Быдлик кто…”, случайно шлёт оскорбительные ответы с помощью подключённого LLM и позволяет администраторам управлять тегами пользователей, шансом/уровнем грубостей и временными банами.

### Возможности
- Ответы на шаблонные вопросы: “кто/кого/у кого/кому/кем/в ком/чей/чьё/чья/чьи”, “когда”, “насколько”, “сколько”, “или” и т. д. (при первом запуске глобальные шаблоны автоматически заносятся в базу).
- Управление тегом: пользователь может сам отключить/включить, админы — настраивать тег любого участника и просматривать список (`Быдлик покажи юзеров`).
- Настройки оскорблений: шанс, уровень (2‑4), глобальный множитель; при срабатывании бот отправляет ответ от LLM либо случайную фразу из `app/texts.py`.
- Админские действия: добавить вопрос, назначить/снять админа, бан/разбан с длительностью, просмотр списка пользователей.

### Подготовка окружения
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Создайте файл `.env` в корне `bidlikbot` и задайте переменные:
   ```
   TOKEN=<telegram_bot_token>
   DATABASE_URL=postgresql://user:pass@host:port/dbname
   LLM_BASE_URL=http://localhost:8000/v1   # опционально
   LLM_API_KEY=unused                      # опционально
   LLM_MODEL=grok-3-fast                   # опционально
   ```

### Запуск
```bash
python -m app.main
```

- При старте `Database` создаёт необходимую схему (`users.*`) и наполняет глобальный список вопросов.
- В проде можно использовать `Procfile` и любой процесс‑менеджер (Heroku/Render и т. п.).

### Проверка
- Юнит‑тесты:
  ```bash
  pytest
  ```
- Для ручного теста: добавьте бота в чат, проверьте команды `Быдлик команды`, `Быдлик админские команды`, развлечения “кто/когда/сколько” и административные сценарии (назначение админов, бан, редактирование шаблонов).

### Настройка LLM
`app/llm.py` использует OpenAI‑совместимый API. Можно поднять локальный сервер, указав `LLM_BASE_URL / LLM_API_KEY / LLM_MODEL`, либо оставить значения по умолчанию (фолбэк — фразы из `INSULT_FALLBACKS`).

### Структура
- `app/main.py` — точка входа.
- `app/bot.py` — регистрация Telegram‑хендлеров и команды.
- `app/db.py` — работа с Postgres и авто‑инициализация схемы.
- `app/llm.py` — интеграция с моделью.
- `app/utils.py`, `app/texts.py` — вспомогательные функции и словари.
- `tests/` — базовые тесты утилит и вспомогательной логики бота.

Дополнительные глобальные админы задаются выставлением `is_admin = true` в таблице `users.user`; чатовые админы управляются командами в чате.
